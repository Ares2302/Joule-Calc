import"./fonts-BjYO01QJ.js";const Kt="/sounds/click.mp3";document.getElementById("theme-switcher");const Mt=document.getElementById("sun-icon"),Ct=document.getElementById("moon-icon"),Qt=document.getElementById("calcolaBtn");document.getElementById("infoBtn");document.getElementById("closeInfoModalBtn");const S=document.getElementById("storico"),N=document.getElementById("peso"),k=document.getElementById("velocita"),Xt=document.getElementById("risultato");document.getElementById("avvisoStorico");const Lt=document.getElementById("maxJouleInfo"),Wt=document.getElementById("maxJouleDetails");document.getElementById("clearHistoryBtn");document.getElementById("copyHistoryBtn");document.getElementById("shareHistoryBtn");document.getElementById("openHistoryModalBtn");const ot=document.getElementById("historyModal");document.getElementById("copyAllHistoryBtn");const pt=document.getElementById("fullHistoryContent"),wt=document.getElementById("infoModal"),kt=document.getElementById("exportModal"),z=document.getElementById("messageModal"),Zt=document.getElementById("modalMessage"),H=document.getElementById("confirmationModal"),te=document.getElementById("confirmationModalMessage");document.getElementById("confirmYesBtn");document.getElementById("confirmNoBtn");const Vt=document.getElementById("sectionHelpModal"),ee=document.getElementById("sectionHelpTitle"),oe=document.getElementById("sectionHelpContent");document.getElementById("closeSectionHelpModalBtn");const gt=document.getElementById("tab-joule"),ft=document.getElementById("tab-velocity"),ht=document.getElementById("panel-joule"),yt=document.getElementById("panel-velocity"),nt=document.getElementById("targetJoule"),R=document.getElementById("reversePeso"),ne=document.getElementById("calcolaVelocitaBtn"),ae=document.getElementById("risultatoVelocita"),X=document.getElementById("opticUnitSwitch"),ie=document.getElementById("panels-container"),vt=document.getElementById("tab-compensation"),xt=document.getElementById("panel-compensation"),at=document.getElementById("moaDistance"),_=document.getElementById("moaDrop"),U=document.getElementById("moaDrift"),le=document.getElementById("driftDirection"),se=document.getElementById("calcolaMoaBtn"),rt=document.getElementById("moaPerClick"),Pt=document.getElementById("risultatoAlzo"),zt=document.getElementById("risultatoDeriva"),St=document.documentElement;document.getElementById("menu-btn");const re=document.getElementById("side-menu"),ct=document.getElementById("menu-overlay"),L=document.getElementById("installAppBtn"),G=document.getElementById("install-banner"),ce=document.getElementById("installAppBtnBanner"),de=document.getElementById("closeInstallBannerBtn"),$t=document.getElementById("calculator-section"),Tt=document.getElementById("history-section"),Dt=document.getElementById("scroll-to-history-btn"),Ot=document.getElementById("scroll-to-calculator-btn"),q=document.getElementById("history-scroll-container"),Y=document.getElementById("scrollToHistoryTopBtn"),Rt=.06479891,_t=.3048,ue=50,$=10,Ut="calcolatoreJouleStorico",me={"1/4 MOA per Click":.25,"1/2 MOA per Click":.5,"1/8 MOA per Click":.125,"1 MOA per Click":1},pe={"0.1 MRAD per Click":.1,"0.05 MRAD per Click":.05},ge={joule:{title:"Aiuto: Calcolo Joule",content:`
            <p>Questa sezione calcola l'energia cinetica (in Joule) del pallino.</p>
            <ul class="list-disc list-inside space-y-2 mt-2">
                <li><strong>Peso pallino:</strong> Inserisci il peso del pallino. L'unità di misura (grammi o grani) dipende dal selettore Metrico/Imperiale in alto.</li>
                <li><strong>Velocità:</strong> Inserisci la velocità del pallino misurata con un cronografo. L'unità (m/s o fps) dipende dallo stesso selettore.</li>
                <li><strong>Calcola e Salva:</strong> Il pulsante calcola i Joule e aggiunge automaticamente il risultato allo storico sulla destra.</li>
            </ul>
            <p class="mt-4">Per approfondire, leggi la nostra <a href="/guides/guida-introduttiva.html" class="text-indigo-600 dark:text-indigo-400 hover:underline">guida sul calcolo dei Joule</a>.</p>
        `},velocity:{title:"Aiuto: Calcolo Velocità",content:`
            <p>Questa sezione calcola la velocità teorica che un pallino deve avere per raggiungere un determinato valore di Joule.</p>
            <ul class="list-disc list-inside space-y-2 mt-2">
                <li><strong>Joule Desiderati:</strong> Inserisci il valore di energia che vuoi raggiungere (es. 0.99).</li>
                <li><strong>Peso pallino:</strong> Inserisci il peso del pallino che intendi usare.</li>
                <li>Il risultato mostrerà la velocità necessaria sia in metri al secondo (m/s) che in piedi al secondo (fps).</li>
            </ul>
            <p class="mt-4">Questo calcolo si basa sulla formula inversa dell'energia cinetica. Per saperne di più, consulta la <a href="/guides/guida-introduttiva.html" class="text-indigo-600 dark:text-indigo-400 hover:underline">guida principale</a>.</p>
        `},compensation:{title:"Aiuto: Compensazione Ottica",content:`
            <p>Questo strumento ti aiuta a tradurre la deviazione del colpo (osservata sul bersaglio) in "click" da applicare alle torrette della tua ottica.</p>
            <ul class="list-disc list-inside space-y-2 mt-2">
                <li><strong>Unità Ottica:</strong> Scegli se la tua ottica è in MOA (Minute of Angle) o MRAD (Milliradian).</li>
                <li><strong>Distanza al bersaglio:</strong> Inserisci la distanza in metri a cui stai sparando.</li>
                <li><strong>Caduta verticale (Alzo):</strong> Misura di quanti centimetri il pallino è caduto rispetto al punto mirato.</li>
                <li><strong>Spostamento orizzontale (Deriva):</strong> Misura di quanti centimetri il pallino si è spostato a destra o sinistra.</li>
                <li><strong>Valore per Click:</strong> Seleziona il valore di correzione per ogni click della tua ottica (es. 1/4 MOA).</li>
            </ul>
            <p class="mt-4">Per una spiegazione dettagliata su MOA e MRAD, leggi la nostra <a href="/guides/regolare-ottica.html" class="text-indigo-600 dark:text-indigo-400 hover:underline">guida alla regolazione dell'ottica</a>.</p>
        `}};let bt=null;const Bt=t=>{t.classList.add("visible"),t.style.display="flex",t.setAttribute("aria-hidden","false"),document.body.style.overflow="hidden"},j=t=>{t.classList.remove("visible"),t.style.display="none",t.setAttribute("aria-hidden","true"),document.body.style.overflow=""},It=(t,e)=>{te.textContent=t,bt=e,Bt(H)},y=(t,e=!0)=>{Zt.textContent=t,z.classList.remove("bg-green-500","bg-red-500"),z.classList.add(e?"bg-green-500":"bg-red-500"),z.classList.add("show"),setTimeout(()=>{z.classList.remove("show")},3e3)},dt=(t,e="Testo copiato negli appunti!")=>{navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(t).then(()=>{y(e)}).catch(()=>{At(t,e)}):At(t,e)},At=(t,e)=>{const o=document.createElement("textarea");o.value=t,o.style.position="fixed",o.style.left="-9999px",document.body.appendChild(o),o.focus(),o.select();try{document.execCommand("copy"),y(e)}catch{y("Errore durante la copia. Prova a selezionare e copiare manualmente.",!1)}document.body.removeChild(o)};function Ht(){return bt}function K(){bt=null}const fe=t=>{const e=t==="imperiale",o=document.getElementById("labelPeso"),r=document.getElementById("labelVelocita"),d=document.getElementById("labelReversePeso");e?(o.textContent="Peso pallino (in grani)",r.textContent="Velocità (in fps)",d.textContent="Peso pallino (in grani)",N.placeholder="Esempio: 3.09",k.placeholder="Esempio: 326.4"):(o.textContent="Peso pallino (in grammi)",r.textContent="Velocità (in m/s)",d.textContent="Peso pallino (in grammi)",N.placeholder="Esempio: 0.20",k.placeholder="Esempio: 99.5")},he=t=>{t==="dark"?(St.classList.add("dark"),Mt.classList.add("hidden"),Ct.classList.remove("hidden")):(St.classList.remove("dark"),Mt.classList.remove("hidden"),Ct.classList.add("hidden"))},ye=()=>window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",Gt=()=>localStorage.getItem("theme")||ye(),jt=()=>{const e=X.checked?pe:me;rt.innerHTML="";for(const[o,r]of Object.entries(e))rt.add(new Option(o,r))};function ve(t){const e=ge[t];e&&(ee.textContent=e.title,oe.innerHTML=e.content,Bt(Vt))}const xe=t=>{var u;const e=[gt,ft,vt],o={"tab-joule":{color:"indigo"},"tab-velocity":{color:"teal"},"tab-compensation":{color:"purple"}},r=["border-transparent","text-gray-500","hover:text-gray-700","hover:border-gray-300","dark:text-gray-400","dark:hover:text-gray-300","dark:hover:border-gray-500"];e.forEach(c=>{var a;const s=(a=o[c.id])==null?void 0:a.color;s&&(c.classList.remove(`border-${s}-500`,`text-${s}-600`,`dark:border-${s}-400`,`dark:text-${s}-400`),c.classList.remove("active")),c.classList.add(...r)});const d=(u=o[t.id])==null?void 0:u.color;d&&(t.classList.remove(...r),t.classList.add(`border-${d}-500`,`text-${d}-600`,`dark:border-${d}-400`,`dark:text-${d}-400`),t.classList.add("active"))};let v=[],J={},D={},E=$;function be(){const t="history-animation-styles";if(document.getElementById(t))return;const e=document.createElement("style");e.id=t,e.innerHTML=`
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .history-item-animate {
            animation: fadeInDown 0.4s ease-out forwards;
        }
        @keyframes fadeOutAndShrink {
            to {
                opacity: 0;
                transform: scale(0.95);
                height: 0;
                padding-top: 0;
                padding-bottom: 0;
                margin-top: 0;
                margin-bottom: 0;
                border: 0;
            }
        }
        .history-item-deleting {
            overflow: hidden;
            animation: fadeOutAndShrink 0.4s ease-out forwards;
        }
        .history-list {
            transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out;
            max-height: 1000px; /* Un valore abbastanza grande da contenere gli elementi */
            overflow: hidden;
            opacity: 1;
        }
        .history-list.collapsed {
            max-height: 0;
            opacity: 0;
        }
    `,document.head.appendChild(e)}be();function Et(){return v}function Be(t){v.unshift(t),tt()}function Ie(){return v.length>=ue}const Ee=()=>{localStorage.setItem(Ut,JSON.stringify(v))},Me=()=>{const t=localStorage.getItem(Ut);t&&(v=JSON.parse(t).map(e=>({...e,data:new Date(e.data)}))),E=$,T(S,v,!0,!0),T(pt,v,!1,!1)},Ce=()=>{It("Sei sicuro di voler cancellare tutto lo storico dei calcoli? Questa azione non può essere annullata.",()=>{v=[],J={},tt(),y("Storico cancellato con successo!")})},Le=t=>{It("Sei sicuro di voler eliminare questo calcolo?",()=>{const e=parseFloat(t),o=document.querySelector(`.history-item[data-item-id="${e}"]`),r=()=>{const d=v.filter(u=>u.id!==e);d.length<v.length&&(v=d,tt(!1),y("Calcolo eliminato!"))};o?(o.classList.add("history-item-deleting"),o.addEventListener("animationend",r,{once:!0})):r()})},we=t=>{It(`Sei sicuro di voler eliminare tutti i calcoli per i pallini da ${t}?`,()=>{const e=document.querySelector(`.history-group[data-group-peso="${t}"]`),o=()=>{v=v.filter(r=>r.pesoOriginale.toFixed(2)!==t),delete J[t],tt(!1),y("Gruppo di calcoli eliminato!")};e?(e.classList.add("history-item-deleting"),e.addEventListener("animationend",o,{once:!0})):o()})},ke=t=>{const e=v.filter(s=>s.pesoOriginale.toFixed(2)===t);if(e.length===0){y("Nessun calcolo da copiare per questo gruppo.",!1);return}const o=e[0].unita.split(" ")[0],r=e[0].unita.split(" ")[2],d=e.reduce((s,a)=>s+a.joule,0)/e.length;let u=`--- Peso: ${t} ${o} (Media: ${d.toFixed(2)} J) ---
`;[...e].sort((s,a)=>a.data-s.data).forEach(s=>{const a=new Date(s.data),l=a.toLocaleDateString("it-IT"),m=a.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"});u+=`- ${l} ${m} | ${s.joule.toFixed(2)} J (${s.velocitaOriginale.toFixed(2)} ${r})
`}),u+=`
Copiato da Joule-Calc`,dt(u,"Gruppo copiato negli appunti!")};function tt(t=!0){t?E=$:E=Math.max($,E-1);const e=new Set;if(t&&v.length>0&&e.add(v[0].id),t){const o=document.getElementById("history-scroll-container");o&&o.scrollTop>0&&o.scrollTo({top:0,behavior:"smooth"})}T(S,v,!0,!0,{animatedItemIds:e}),T(pt,v,!1,!1),Ee()}function Se(t,e,o,r){const d=e.length,u=d-E;if(u<=0||E>=d)return;const c=Math.min($,u),s=document.createElement("button");s.id="load-more-history",s.className="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition-colors duration-200",s.textContent=`Mostra altri ${c} (ne rimangono ${u})`,s.addEventListener("click",()=>{const a=E;E+=$;const l=new Set(e.slice(a,E).map(m=>m.id));T(t,e,o,r,{animatedItemIds:l})}),t.appendChild(s)}const T=(t=S,e=v,o=!0,r=!1,d={})=>{const{animatedItemIds:u=new Set}=d;if(t.innerHTML="",e.length===0){t.innerHTML='<div class="text-center text-gray-500 dark:text-gray-400 py-10">Lo storico dei calcoli apparirà qui.</div>',t===S&&Lt.classList.add("hidden");return}const c=e.reduce((n,i)=>{const p=i.pesoOriginale.toFixed(2);return n[p]||(n[p]=[]),n[p].push(i),n},{}),s=Object.keys(c).sort((n,i)=>{const p=c[n].reduce((b,x)=>x.data>b?x.data:b,new Date(0));return c[i].reduce((b,x)=>x.data>b?x.data:b,new Date(0))-p}),a=s.flatMap(n=>{const i=c[n],p=J[n]||"recent",I=[...i];switch(p){case"recent":I.sort((b,x)=>x.data-b.data);break;case"oldest":I.sort((b,x)=>b.data-x.data);break;case"joule-desc":I.sort((b,x)=>x.joule-x.joule);break;case"joule-asc":I.sort((b,x)=>b.joule-x.joule);break}return I}),m=(r?a.slice(0,E):a).reduce((n,i)=>{const p=i.pesoOriginale.toFixed(2);return n[p]||(n[p]=[]),n[p].push(i),n},{});if(s.forEach(n=>{if(!m[n])return;let i=m[n];const p=J[n]||"recent",b=c[n].reduce((g,h)=>g+h.joule,0)/c[n].length,x=c[n][0].unita.split(" ")[0],C=document.createElement("div");C.className="history-group bg-gray-100 dark:bg-gray-700 p-4 rounded-lg shadow-sm",C.dataset.groupPeso=n;const M=document.createElement("div");M.className="flex flex-col sm:flex-row justify-between items-center mb-2 cursor-pointer",M.addEventListener("click",g=>{if(g.target.closest("select, button"))return;const h=`list-${n}-${t.id}`,B=document.getElementById(h),A=M.querySelector(".collapse-icon");B&&(D[n]=!D[n],B.classList.toggle("collapsed",D[n]),A&&(A.style.transform=D[n]?"rotate(-90deg)":"rotate(0deg)"))});const F=document.createElement("span");F.className="collapse-icon text-blue-800 dark:text-blue-200 transition-transform duration-300",F.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>',F.style.transform=D[n]?"rotate(-90deg)":"rotate(0deg)";const V=document.createElement("div");V.className="flex items-center gap-2 bg-blue-200 text-blue-800 dark:bg-blue-900 dark:text-blue-200 text-sm font-bold p-2 rounded-md text-center mb-2 sm:mb-0 w-full sm:w-auto justify-between";const P=document.createElement("span");P.className="flex items-center gap-2",P.textContent=`Media Joule (${n} ${x}): ${b.toFixed(2)} J`,P.prepend(F),V.appendChild(P),M.appendChild(V);const et=document.createElement("div");if(et.className="flex items-center gap-2",c[n].length>1){const g=document.createElement("select");g.id=`sort-${n}`,g.setAttribute("data-peso",n),g.className="block pl-3 pr-8 py-1 text-xs border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 rounded-md",g.innerHTML=`
                <option value="recent" ${p==="recent"?"selected":""}>Più recente</option>
                <option value="oldest" ${p==="oldest"?"selected":""}>Meno recente</option>
                <option value="joule-desc" ${p==="joule-desc"?"selected":""}>Joule (Max)</option>
                <option value="joule-asc" ${p==="joule-asc"?"selected":""}>Joule (Min)</option>
            `,g.addEventListener("change",A=>{J[A.target.dataset.peso]=A.target.value,E=$,T(t,e,o,r)});const h=document.createElement("label");h.setAttribute("for",`sort-${n}`),h.className="text-sm text-gray-600 dark:text-gray-300",h.textContent="Ordina:";const B=document.createElement("div");B.className="flex items-center gap-2",B.appendChild(h),B.appendChild(g),et.appendChild(B)}if(o){const g=document.createElement("div");g.className="flex items-center";const h=document.createElement("button");h.className="text-blue-500 hover:text-blue-700 p-1 rounded-full transition-colors duration-200",h.setAttribute("data-action","copy-group"),h.setAttribute("data-peso",n),h.setAttribute("aria-label",`Copia tutti i calcoli per il peso ${n}`),h.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>',g.appendChild(h);const B=document.createElement("button");B.className="text-red-500 hover:text-red-700 p-1 rounded-full transition-colors duration-200 ml-1",B.setAttribute("data-action","delete-group"),B.setAttribute("data-peso",n),B.setAttribute("aria-label",`Elimina tutti i calcoli per il peso ${n}`),B.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>',g.appendChild(B),V.appendChild(g)}M.appendChild(et),C.appendChild(M);const O=document.createElement("div");O.id=`list-${n}-${t.id}`,O.className="history-list space-y-2 pt-2",D[n]&&O.classList.add("collapsed"),i.forEach(g=>{const h=document.createElement("div");h.className="history-item bg-gray-200 dark:bg-gray-600 p-3 rounded-md flex justify-between items-center",h.dataset.itemId=g.id,u.has(g.id)&&h.classList.add("history-item-animate");let B=o?`
                <button class="text-red-500 hover:text-red-700 p-1 rounded-full transition-colors duration-200" data-action="delete-single" data-id="${g.id}" aria-label="Elimina singolo calcolo">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>`:"";h.innerHTML=`
                <div>
                    <p class="text-sm font-medium dark:text-white">Joule: <span class="font-bold">${g.joule.toFixed(2)}</span></p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">${new Date(g.data).toLocaleString()}</p>
                </div>
                <div class="flex items-center gap-2">
                    <div class="text-right">
                        <p class="text-xs text-gray-700 dark:text-gray-300">Velocità: ${g.velocitaOriginale.toFixed(2)} ${g.unita.split(" ")[2]}</p>
                    </div>
                    ${B}
                </div>
            `,O.appendChild(h)}),C.appendChild(O),t.appendChild(C)}),r&&Se(t,a,o,r),t===S&&e.length>0){const n=Math.max(...e.map(p=>p.joule)),i=e.find(p=>p.joule===n);Lt.classList.remove("hidden"),Wt.innerHTML=`
            <p>
                Il risultato più alto è di <span class="font-bold text-lg">${n.toFixed(2)} J</span>,
                ottenuto con un pallino da <span class="font-bold">${i.pesoOriginale.toFixed(2)} ${i.unita.split(" ")[0]}</span>
                e una velocità di <span class="font-bold">${i.velocitaOriginale.toFixed(2)} ${i.unita.split(" ")[2]}</span>.
            </p>
            <p class="text-xs text-gray-600 dark:text-gray-400 mt-2">Registrato il: ${new Date(i.data).toLocaleString()}</p>
        `}},w=(t,e)=>{t.addEventListener("keydown",o=>{o.key==="Enter"&&(o.preventDefault(),typeof e=="function"?(t.blur(),e()):e&&e.focus())})},$e=()=>{const t=Et();if(t.length===0){y("Lo storico è vuoto. Nessun dato da esportare.",!1);return}const o=[["Data","Ora","Peso","Unita Peso","Velocita","Unita Velocita","Joule"].join(",")],r=[...t].sort((l,m)=>l.data-m.data);for(const l of r){const m=new Date(l.data),n=m.toLocaleDateString("it-IT"),i=m.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit",second:"2-digit"}),p=l.unita.split(" "),I=p[0],b=p[2],C=[n,i,l.pesoOriginale.toFixed(2),I,l.velocitaOriginale.toFixed(2),b,l.joule.toFixed(3)].map(M=>`"${String(M).replace(/"/g,'""')}"`);o.push(C.join(","))}const d=o.join(`
`),u=new Blob([d],{type:"text/csv;charset=utf-8;"}),c=URL.createObjectURL(u),s=document.createElement("a"),a=new Date().toISOString().slice(0,10).replace(/-/g,"");s.setAttribute("href",c),s.setAttribute("download",`storico_joule_${a}.csv`),s.style.visibility="hidden",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(c),y("Esportazione CSV completata!")},Z=()=>{const t=Et();if(t.length===0)return"Nessun calcolo nello storico da condividere.";let e=`I miei risultati:

`;const o=t.reduce((u,c)=>{const s=c.pesoOriginale.toFixed(2);return u[s]||(u[s]={unita:c.unita,calcoli:[]}),u[s].calcoli.push(c),u},{});Object.keys(o).sort((u,c)=>{const s=Math.max(...o[u].calcoli.map(l=>l.data.getTime()));return Math.max(...o[c].calcoli.map(l=>l.data.getTime()))-s}).forEach(u=>{const c=o[u],s=c.unita.split(" ")[0],a=c.unita.split(" ")[2],l=c.calcoli.reduce((n,i)=>n+i.joule,0)/c.calcoli.length;e+=`--- Peso: ${u} ${s} (Media: ${l.toFixed(2)} J) ---
`,[...c.calcoli].sort((n,i)=>i.data-n.data).forEach(n=>{const i=new Date(n.data),p=i.toLocaleDateString("it-IT"),I=i.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"});e+=`- ${p} ${I} | ${n.joule.toFixed(2)} J (${n.velocitaOriginale.toFixed(2)} ${a})
`}),e+=`
`});const d=t.reduce((u,c)=>c.joule>u.joule?c:u,t[0]);return e+=`--- Risultato Massimo ---
`,e+=`Il valore più alto registrato è ${d.joule.toFixed(2)} J con un pallino da ${d.pesoOriginale.toFixed(2)} ${d.unita.split(" ")[0]} a ${d.velocitaOriginale.toFixed(2)} ${d.unita.split(" ")[2]}.
`,e},Nt=t=>{const o={title:"Storico Calcoli Joule",text:Z()+`

---
Generato da Joule-Calc: https://joule-calc.web.app/`};navigator.share&&navigator.canShare&&navigator.canShare(o)?navigator.share(o).then(()=>y("Storico condiviso con successo!")).catch(r=>{r.name!=="AbortError"&&y("Condivisione annullata o fallita.",!1)}):y('La condivisione non è supportata su questo browser o dispositivo. Usa il tasto "Copia".',!1)},Te=()=>{if(Et().length===0){y("Lo storico è vuoto. Nessun dato da stampare.",!1);return}const e=Z().replace(/---/g,'<hr style="margin: 20px 0; border: 1px solid #ccc;">').replace(/\n/g,"<br>"),o=window.open("","_blank");o.document.write(`
        <html>
        <head>
            <title>Stampa Storico - Joule-Calc</title>
            <style>
                body { 
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
                    line-height: 1.6; 
                    color: #333;
                }
                h1 { 
                    text-align: center; 
                    border-bottom: 2px solid #eee; 
                    padding-bottom: 10px; 
                    margin-bottom: 20px;
                }
                hr {
                    border: 0;
                    border-top: 1px solid #ddd;
                    margin: 20px 0;
                }
                p { margin: 0; }
                .footer { 
                    margin-top: 30px; 
                    text-align: center; 
                    font-size: 0.8em; 
                    color: #777;
                }
            </style>
        </head>
        <body>
            <h1>Storico Calcoli Joule-Calc</h1>
            <p>${e}</p>
            <div class="footer">
                Generato da Joule-Calc: https://joule-calc.web.app/
            </div>
        </body>
        </html>
    `),o.document.close(),o.focus(),o.print()};function De(t,e,o){if(isNaN(t)||isNaN(e)||t<=0||e<=0)throw new Error("Valori di input non validi.");return o&&(t=t*Rt,e=e*_t),.5*(t/1e3)*(e*e)}function Oe(t,e,o){if(isNaN(t)||isNaN(e)||t<=0||e<=0)throw new Error("Valori di input non validi.");let r;o?r=e*Rt/1e3:r=e/1e3;const d=Math.sqrt(2*t/r),u=d/_t;return{mps:d,fps:u}}function Ae(t){const{isMrad:e,distance:o,drop:r,drift:d,clickValue:u}=t;if(isNaN(o)||o<=0||r<=0&&d<=0)throw new Error("Distanza o deviazione non valide.");const c=s=>{if(s<=0)return{value:0,clicks:0};let a;e?a=s/(o/10):a=s/o*100/2.9089;const l=a/u;return{value:a,clicks:l}};return{elevation:c(r),windage:c(d)}}let ut=null;function He(t,e,o){const r=o.isMrad?"MRAD":"MOA",d=o.dropDirection==="Down"?"l'alto":"il basso",u=o.driftDirection==="Right"?"sinistra":"destra";let c='<p class="font-semibold mb-1">Verticale</p>';t.clicks>0?c+=`<div><span class="font-bold text-xl">${t.clicks.toFixed(1)} clicks</span></div><div class="text-xs">(${t.value.toFixed(2)} ${r}) verso ${d}</div>`:c+='<p class="text-sm text-gray-600 dark:text-gray-400">Nessuna correzione</p>',Pt.innerHTML=c;let s='<p class="font-semibold mb-1">Orizzontale</p>';e.clicks>0?s+=`<div><span class="font-bold text-xl">${e.clicks.toFixed(1)} clicks</span></div><div class="text-xs">(${e.value.toFixed(2)} ${r}) verso ${u}</div>`:s+='<p class="text-sm text-gray-600 dark:text-gray-400">Nessuna correzione</p>',zt.innerHTML=s}const it=t=>{!t||ut||(Bt(t),ut=t,history.pushState({modalOpen:!0,modalId:t.id},""))},Q=(t,e=!1)=>{!t||t.style.display==="none"||(j(t),ut=null,!e&&history.state&&history.state.modalOpen&&history.back())},W="jouleCalcUnitSystem",Jt=t=>{fe(t),localStorage.setItem(W,t),document.querySelectorAll("[data-unit-selector]").forEach(o=>{const r=o.querySelector('[data-unit-button="metrico"]'),d=o.querySelector('[data-unit-button="imperiale"]');r&&r.classList.toggle("active-unit",t==="metrico"),d&&d.classList.toggle("active-unit",t==="imperiale")})},mt=new Audio(Kt);mt.preload="auto";const lt=()=>{mt.currentTime=0,mt.play().catch(t=>console.warn("La riproduzione del suono non è riuscita:",t))},f=(t=10)=>{navigator&&"vibrate"in navigator&&navigator.vibrate(t)};document.addEventListener("DOMContentLoaded",()=>{document.getElementById("appContainer")&&je()});function je(){qt(Gt()),Ne(),document.body.addEventListener("click",a=>{const m=a.target.closest("button");if(!m)return;const n=m.dataset.helpTopic;n&&ve(n);const i=m.id;if(i==="infoBtn"){it(wt);return}if(i==="closeInfoModalBtn"){Q(wt);return}if(i==="confirmYesBtn"){f(20),j(H);const p=Ht();p&&p(),K();return}if(i==="confirmNoBtn"){f(),j(H),K();return}if(i==="closeSectionHelpModalBtn"){Q(Vt);return}if(i==="confirmYesBtn"){f(20),j(H);const p=Ht();p&&p(),K();return}if(i==="confirmNoBtn"){f(),j(H),K();return}if(i==="menu-btn"){st(!0);return}if(i==="close-menu-btn"){st(!1);return}if(i==="calcolaBtn"){o();return}if(i==="calcolaVelocitaBtn"){r();return}if(i==="calcolaMoaBtn"){d();return}if(i==="clearHistoryBtn"||i==="clearAllHistoryBtn"){f(20),Ce();return}if(i==="copyHistoryBtn"||i==="copyAllHistoryBtn"||i==="exportTxtBtnModal"){f(),dt(Z(),"Storico copiato negli appunti!");return}if(i==="shareHistoryBtn"||i==="shareBtnModal"){f(),Nt();return}if(i==="exportBtn"){f(),it(kt);return}if(i==="openHistoryModalBtn"){T(pt,void 0,!1),it(ot);return}}),ct&&ct.addEventListener("click",()=>st(!1)),Me();const t=()=>{const a=window.innerHeight*.01;document.documentElement.style.setProperty("--vh",`${a}px`)};window.addEventListener("resize",t),t(),Dt&&Tt&&Dt.addEventListener("click",()=>{f(),Tt.scrollIntoView({behavior:"smooth"})}),Ot&&$t&&Ot.addEventListener("click",()=>{f(),$t.scrollIntoView({behavior:"smooth"})}),Y&&q&&(Y.addEventListener("click",a=>{a.preventDefault(),f(),q.scrollTo({top:0,behavior:"smooth"})}),q.addEventListener("scroll",()=>{const a=q.scrollTop>50;Y.classList.toggle("opacity-100",a),Y.classList.toggle("pointer-events-auto",a)}));let e;if(L&&G){window.addEventListener("beforeinstallprompt",l=>{l.preventDefault(),e=l;const m=localStorage.getItem("joule-calc-install-banner-dismissed-timestamp");!m||Date.now()-parseInt(m,10)>7*24*60*60*1e3?G.classList.remove("hidden"):L.classList.remove("hidden","opacity-0")});const a=()=>{e&&(f(),e.prompt(),L.classList.add("hidden"),G.classList.add("hidden"))};L.addEventListener("click",a),ce.addEventListener("click",a),de.addEventListener("click",()=>{f(),G.classList.add("hidden"),localStorage.setItem("joule-calc-install-banner-dismissed-timestamp",Date.now().toString()),L.classList.contains("hidden")&&(L.classList.remove("hidden"),setTimeout(()=>L.classList.remove("opacity-0"),10))}),window.addEventListener("appinstalled",()=>{e=null,y("App installata con successo!",!0)})}const o=()=>{f();try{const a=parseFloat(N.value),l=parseFloat(k.value),m=(localStorage.getItem(W)||"metrico")==="imperiale",n=De(a,l,m);lt(),Xt.innerHTML=`<span class="font-semibold">Energia in Joule:</span> <span id="joule-value" class="font-bold text-xl">${n.toFixed(2)}</span>`,Ie()?y("Storico pieno! Calcolo non salvato.",!1):(Be({id:Date.now(),pesoOriginale:a,velocitaOriginale:l,unita:m?"gr e fps":"g e m/s",joule:n,data:new Date}),y("Calcolo salvato nello storico!")),k.value=""}catch{y("Dati non validi!",!1)}},r=()=>{f();try{const a=parseFloat(nt.value),l=parseFloat(R.value),m=(localStorage.getItem(W)||"metrico")==="imperiale",{mps:n,fps:i}=Oe(a,l,m);lt(),ae.innerHTML=`<p class="font-semibold">Velocità necessaria:</p><p><span class="font-bold text-xl">${n.toFixed(2)}</span> m/s</p><p><span class="font-bold text-xl">${i.toFixed(2)}</span> fps</p>`}catch{y("Dati non validi!",!1)}},d=()=>{f();try{const a={isMrad:X.checked,distance:parseFloat(at.value),drop:parseFloat(_.value)||0,drift:parseFloat(U.value)||0,dropDirection:document.getElementById("dropDirection").value,driftDirection:le.value,clickValue:parseFloat(rt.value)},{elevation:l,windage:m}=Ae(a);lt(),He(l,m,a)}catch{Pt.innerHTML='<p class="font-semibold mb-1">Verticale</p><p class="text-sm text-gray-600 dark:text-gray-400">Nessuna correzione</p>',zt.innerHTML='<p class="font-semibold mb-1">Orizzontale</p><p class="text-sm text-gray-600 dark:text-gray-400">Nessuna correzione</p>',y("Dati non validi!",!1)}};N&&k&&Qt&&(w(N,k),w(k,o)),nt&&R&&ne&&(w(nt,R),w(R,r)),at&&_&&U&&se&&(w(at,_),w(_,U),w(U,d)),document.body.addEventListener("click",a=>{const l=a.target.closest("[data-unit-button]");l&&(f(),Jt(l.dataset.unitButton))});const u=[gt,ft,vt],c=[ht,yt,xt];if(ie&&u.forEach((a,l)=>{a&&a.addEventListener("click",()=>{f(),Yt(u[l],c[l])})}),S&&S.addEventListener("click",a=>{const l=a.target.closest("button[data-action]");if(!l)return;const m=l.dataset.action,n=l.dataset.id,i=l.dataset.peso;m==="delete-single"&&n?Le(n):m==="delete-group"&&i?we(i):m==="copy-group"&&i&&ke(i)}),kt){const a=document.getElementById("exportModal");a&&a.addEventListener("click",l=>{(l.target.id==="closeExportModalBtn"||l.target.closest("#closeExportModalBtn"))&&Q(a),(l.target.id==="exportCsvBtnModal"||l.target.closest("#exportCsvBtnModal"))&&(f(),$e()),(l.target.id==="exportTxtBtnModal"||l.target.closest("#exportTxtBtnModal"))&&(f(),dt(Z(),"Storico copiato negli appunti!")),(l.target.id==="printBtnModal"||l.target.closest("#printBtnModal"))&&(f(),Te()),(l.target.id==="shareBtnModal"||l.target.closest("#shareBtnModal"))&&(f(),Nt())})}if(ot){const a=document.getElementById("closeHistoryModalXBtn");a&&a.addEventListener("click",()=>Q(ot))}const s=localStorage.getItem(W)||"metrico";Jt(s),X&&(jt(),X.addEventListener("change",()=>{f(),jt()})),Ft(),window.addEventListener("hashchange",Ft)}function st(t){const e=re,o=ct;!e||!o||(t?(o.classList.remove("hidden"),e.classList.remove("translate-x-full")):(o.classList.add("hidden"),e.classList.add("translate-x-full")))}const qt=t=>{he(t);const e=t==="dark"?"#1f2937":"#ffffff",o=document.querySelector('meta[name="theme-color"]');o&&o.setAttribute("content",e)};function Yt(t,e){[ht,yt,xt].forEach(r=>r.classList.add("hidden")),e.classList.remove("hidden"),xe(t)}function Ft(){const t=window.location.hash.substring(1),e={joule:{tab:gt,panel:ht},velocity:{tab:ft,panel:yt},compensation:{tab:vt,panel:xt}};t&&e[t]&&Yt(e[t].tab,e[t].panel)}function Ne(){document.querySelectorAll("#theme-switcher").forEach(t=>{t.addEventListener("click",()=>{const e=Gt()==="dark"?"light":"dark";localStorage.setItem("theme",e),qt(e)})})}
