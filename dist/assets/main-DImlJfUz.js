import"./fonts-DWzKQEqs.js";const Kt="/sounds/click.mp3";document.getElementById("theme-switcher");const Mt=document.getElementById("sun-icon"),Lt=document.getElementById("moon-icon"),Qt=document.getElementById("calcolaBtn");document.getElementById("infoBtn");document.getElementById("closeInfoModalBtn");const S=document.getElementById("storico"),D=document.getElementById("peso"),L=document.getElementById("velocita"),Xt=document.getElementById("risultato");document.getElementById("avvisoStorico");const wt=document.getElementById("maxJouleInfo"),Wt=document.getElementById("maxJouleDetails");document.getElementById("clearHistoryBtn");document.getElementById("copyHistoryBtn");document.getElementById("shareHistoryBtn");document.getElementById("openHistoryModalBtn");const dt=document.getElementById("historyModal");document.getElementById("copyAllHistoryBtn");const Vt=document.getElementById("fullHistoryContent"),Ct=document.getElementById("infoModal"),kt=document.getElementById("exportModal"),U=document.getElementById("messageModal"),Zt=document.getElementById("modalMessage"),mt=document.getElementById("confirmationModal"),te=document.getElementById("confirmationModalMessage");document.getElementById("confirmYesBtn");document.getElementById("confirmNoBtn");const pt=document.getElementById("sectionHelpModal"),ee=document.getElementById("sectionHelpTitle"),oe=document.getElementById("sectionHelpContent");document.getElementById("closeSectionHelpModalBtn");const ot=document.getElementById("tab-joule"),nt=document.getElementById("tab-velocity"),at=document.getElementById("panel-joule"),it=document.getElementById("panel-velocity"),X=document.getElementById("targetJoule"),J=document.getElementById("reversePeso"),ne=document.getElementById("calcolaVelocitaBtn"),ae=document.getElementById("risultatoVelocita"),W=document.getElementById("opticUnitSwitch"),ie=document.getElementById("panels-container"),st=document.getElementById("tab-compensation"),lt=document.getElementById("panel-compensation"),Z=document.getElementById("moaDistance"),N=document.getElementById("moaDrop"),G=document.getElementById("moaDrift"),se=document.getElementById("driftDirection"),le=document.getElementById("calcolaMoaBtn"),gt=document.getElementById("moaPerClick"),Pt=document.getElementById("risultatoAlzo"),zt=document.getElementById("risultatoDeriva"),St=document.documentElement;document.getElementById("menu-btn");const Rt=document.getElementById("side-menu");document.getElementById("close-menu-btn");const ft=document.getElementById("menu-overlay"),C=document.getElementById("installAppBtn"),q=document.getElementById("install-banner"),re=document.getElementById("installAppBtnBanner"),ce=document.getElementById("closeInstallBannerBtn"),$t=document.getElementById("calculator-section"),Tt=document.getElementById("history-section"),Ot=document.getElementById("scroll-to-history-btn"),Dt=document.getElementById("scroll-to-calculator-btn"),Y=document.getElementById("history-scroll-container"),K=document.getElementById("scrollToHistoryTopBtn"),_t=.06479891,Ut=.3048,de=50,$=10,Gt="calcolatoreJouleStorico",ue={"1/4 MOA per Click":.25,"1/2 MOA per Click":.5,"1/8 MOA per Click":.125,"1 MOA per Click":1},me={"0.1 MRAD per Click":.1,"0.05 MRAD per Click":.05},pe={joule:{title:"Aiuto: Calcolo Joule",content:`
            <p>Questa sezione calcola l'energia cinetica (in Joule) del pallino.</p>
            <ul class="list-disc list-inside space-y-2 mt-2">
                <li><strong>Peso pallino:</strong> Inserisci il peso del pallino. L'unità di misura (grammi o grani) dipende dal selettore Metrico/Imperiale in alto.</li>
                <li><strong>Velocità:</strong> Inserisci la velocità del pallino misurata con un cronografo. L'unità (m/s o fps) dipende dallo stesso selettore.</li>
                <li><strong>Calcola e Salva:</strong> Il pulsante calcola i Joule e aggiunge automaticamente il risultato allo storico sulla destra.</li>
            </ul>
            <p class="mt-4">Per approfondire, leggi la nostra <a href="/guides/guida-introduttiva.html" class="text-indigo-600 dark:text-indigo-400 hover:underline">guida sul calcolo dei Joule</a>.</p>
        `},velocity:{title:"Aiuto: Calcolo Velocità",content:`
            <p>Questa sezione calcola la velocità teorica che un pallino deve avere per raggiungere un determinato valore di Joule.</p>
            <ul class="list-disc list-inside space-y-2 mt-2">
                <li><strong>Joule Desiderati:</strong> Inserisci il valore di energia che vuoi raggiungere (es. 0.99).</li>
                <li><strong>Peso pallino:</strong> Inserisci il peso del pallino che intendi usare.</li>
                <li>Il risultato mostrerà la velocità necessaria sia in metri al secondo (m/s) che in piedi al secondo (fps).</li>
            </ul>
            <p class="mt-4">Questo calcolo si basa sulla formula inversa dell'energia cinetica. Per saperne di più, consulta la <a href="/guides/guida-introduttiva.html" class="text-indigo-600 dark:text-indigo-400 hover:underline">guida principale</a>.</p>
        `},compensation:{title:"Aiuto: Compensazione Ottica",content:`
            <p>Questo strumento ti aiuta a tradurre la deviazione del colpo (osservata sul bersaglio) in "click" da applicare alle torrette della tua ottica.</p>
            <ul class="list-disc list-inside space-y-2 mt-2">
                <li><strong>Unità Ottica:</strong> Scegli se la tua ottica è in MOA (Minute of Angle) o MRAD (Milliradian).</li>
                <li><strong>Distanza al bersaglio:</strong> Inserisci la distanza in metri a cui stai sparando.</li>
                <li><strong>Caduta verticale (Alzo):</strong> Misura di quanti centimetri il pallino è caduto rispetto al punto mirato.</li>
                <li><strong>Spostamento orizzontale (Deriva):</strong> Misura di quanti centimetri il pallino si è spostato a destra o sinistra.</li>
                <li><strong>Valore per Click:</strong> Seleziona il valore di correzione per ogni click della tua ottica (es. 1/4 MOA).</li>
            </ul>
            <p class="mt-4">Per una spiegazione dettagliata su MOA e MRAD, leggi la nostra <a href="/guides/regolare-ottica.html" class="text-indigo-600 dark:text-indigo-400 hover:underline">guida alla regolazione dell'ottica</a>.</p>
        `}};let bt=null;const xt=t=>{t.classList.add("visible"),t.style.display="flex",t.setAttribute("aria-hidden","false"),document.body.style.overflow="hidden"},ht=t=>{t.classList.remove("visible"),t.style.display="none",t.setAttribute("aria-hidden","true"),document.body.style.overflow=""},It=(t,e)=>{te.textContent=t,bt=e,xt(mt)},y=(t,e=!0)=>{Zt.textContent=t,U.classList.remove("bg-green-500","bg-red-500"),U.classList.add(e?"bg-green-500":"bg-red-500"),U.classList.add("show"),setTimeout(()=>{U.classList.remove("show")},3e3)},yt=(t,e="Testo copiato negli appunti!")=>{navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(t).then(()=>{y(e)}).catch(()=>{At(t,e)}):At(t,e)},At=(t,e)=>{const o=document.createElement("textarea");o.value=t,o.style.position="fixed",o.style.left="-9999px",document.body.appendChild(o),o.focus(),o.select();try{document.execCommand("copy"),y(e)}catch{y("Errore durante la copia. Prova a selezionare e copiare manualmente.",!1)}document.body.removeChild(o)};function ge(){return bt}function Ht(){bt=null}const fe=t=>{const e=t==="imperiale",o=document.getElementById("labelPeso"),i=document.getElementById("labelVelocita"),u=document.getElementById("labelReversePeso");e?(o.textContent="Peso pallino (in grani)",i.textContent="Velocità (in fps)",u.textContent="Peso pallino (in grani)",D.placeholder="Esempio: 3.09",L.placeholder="Esempio: 326.4"):(o.textContent="Peso pallino (in grammi)",i.textContent="Velocità (in m/s)",u.textContent="Peso pallino (in grammi)",D.placeholder="Esempio: 0.20",L.placeholder="Esempio: 99.5")},he=t=>{t==="dark"?(St.classList.add("dark"),Mt.classList.add("hidden"),Lt.classList.remove("hidden")):(St.classList.remove("dark"),Mt.classList.remove("hidden"),Lt.classList.add("hidden"))},ye=()=>window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",qt=()=>localStorage.getItem("theme")||ye(),jt=()=>{const e=W.checked?me:ue;gt.innerHTML="";for(const[o,i]of Object.entries(e))gt.add(new Option(o,i))};function ve(t){const e=pe[t];e&&(ee.textContent=e.title,oe.innerHTML=e.content,xt(pt))}const be=t=>{var d;const e=[ot,nt,st],o={"tab-joule":{color:"indigo"},"tab-velocity":{color:"teal"},"tab-compensation":{color:"purple"}},i=["border-transparent","text-gray-500","hover:text-gray-700","hover:border-gray-300","dark:text-gray-400","dark:hover:text-gray-300","dark:hover:border-gray-500"];e.forEach(l=>{var a;const c=(a=o[l.id])==null?void 0:a.color;c&&(l.classList.remove(`border-${c}-500`,`text-${c}-600`,`dark:border-${c}-400`,`dark:text-${c}-400`),l.classList.remove("active")),l.classList.add(...i)});const u=(d=o[t.id])==null?void 0:d.color;u&&(t.classList.remove(...i),t.classList.add(`border-${u}-500`,`text-${u}-600`,`dark:border-${u}-400`,`dark:text-${u}-400`),t.classList.add("active"))};let v=[],F={},T={},E=$;function xe(){const t="history-animation-styles";if(document.getElementById(t))return;const e=document.createElement("style");e.id=t,e.innerHTML=`
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .history-item-animate {
            animation: fadeInDown 0.4s ease-out forwards;
        }
        @keyframes fadeOutAndShrink {
            to {
                opacity: 0;
                transform: scale(0.95);
                height: 0;
                padding-top: 0;
                padding-bottom: 0;
                margin-top: 0;
                margin-bottom: 0;
                border: 0;
            }
        }
        .history-item-deleting {
            overflow: hidden;
            animation: fadeOutAndShrink 0.4s ease-out forwards;
        }
        .history-list {
            transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out;
            max-height: 1000px; /* Un valore abbastanza grande da contenere gli elementi */
            overflow: hidden;
            opacity: 1;
        }
        .history-list.collapsed {
            max-height: 0;
            opacity: 0;
        }
    `,document.head.appendChild(e)}xe();function Bt(){return v}function Ie(t){v.unshift(t),rt()}function Be(){return v.length>=de}const Ee=()=>{localStorage.setItem(Gt,JSON.stringify(v))},Me=()=>{const t=localStorage.getItem(Gt);t&&(v=JSON.parse(t).map(e=>({...e,data:new Date(e.data)}))),E=$,A(S,v,!0,!0),A(Vt,v,!1,!1)},Le=()=>{It("Sei sicuro di voler cancellare tutto lo storico dei calcoli? Questa azione non può essere annullata.",()=>{v=[],F={},rt(),y("Storico cancellato con successo!")})},we=t=>{It("Sei sicuro di voler eliminare questo calcolo?",()=>{const e=parseFloat(t),o=document.querySelector(`.history-item[data-item-id="${e}"]`),i=()=>{const u=v.filter(d=>d.id!==e);u.length<v.length&&(v=u,rt(!1),y("Calcolo eliminato!"))};o?(o.classList.add("history-item-deleting"),o.addEventListener("animationend",i,{once:!0})):i()})},Ce=t=>{It(`Sei sicuro di voler eliminare tutti i calcoli per i pallini da ${t}?`,()=>{const e=document.querySelector(`.history-group[data-group-peso="${t}"]`),o=()=>{v=v.filter(i=>i.pesoOriginale.toFixed(2)!==t),delete F[t],rt(!1),y("Gruppo di calcoli eliminato!")};e?(e.classList.add("history-item-deleting"),e.addEventListener("animationend",o,{once:!0})):o()})},ke=t=>{const e=v.filter(c=>c.pesoOriginale.toFixed(2)===t);if(e.length===0){y("Nessun calcolo da copiare per questo gruppo.",!1);return}const o=e[0].unita.split(" ")[0],i=e[0].unita.split(" ")[2],u=e.reduce((c,a)=>c+a.joule,0)/e.length;let d=`--- Peso: ${t} ${o} (Media: ${u.toFixed(2)} J) ---
`;[...e].sort((c,a)=>a.data-c.data).forEach(c=>{const a=new Date(c.data),r=a.toLocaleDateString("it-IT"),m=a.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"});d+=`- ${r} ${m} | ${c.joule.toFixed(2)} J (${c.velocitaOriginale.toFixed(2)} ${i})
`}),d+=`
Copiato da Joule-Calc`,yt(d,"Gruppo copiato negli appunti!")};function rt(t=!0){t?E=$:E=Math.max($,E-1);const e=new Set;if(t&&v.length>0&&e.add(v[0].id),t){const o=document.getElementById("history-scroll-container");o&&o.scrollTop>0&&o.scrollTo({top:0,behavior:"smooth"})}A(S,v,!0,!0,{animatedItemIds:e}),A(Vt,v,!1,!1),Ee()}function Se(t,e,o,i){const u=e.length,d=u-E;if(d<=0||E>=u)return;const l=Math.min($,d),c=document.createElement("button");c.id="load-more-history",c.className="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition-colors duration-200",c.textContent=`Mostra altri ${l} (ne rimangono ${d})`,c.addEventListener("click",()=>{const a=E;E+=$;const r=new Set(e.slice(a,E).map(m=>m.id));A(t,e,o,i,{animatedItemIds:r})}),t.appendChild(c)}const A=(t=S,e=v,o=!0,i=!1,u={})=>{const{animatedItemIds:d=new Set}=u;if(t.innerHTML="",e.length===0){t.innerHTML='<div class="text-center text-gray-500 dark:text-gray-400 py-10">Lo storico dei calcoli apparirà qui.</div>',t===S&&wt.classList.add("hidden");return}const l=e.reduce((n,s)=>{const g=s.pesoOriginale.toFixed(2);return n[g]||(n[g]=[]),n[g].push(s),n},{}),c=Object.keys(l).sort((n,s)=>{const g=l[n].reduce((x,b)=>b.data>x?b.data:x,new Date(0));return l[s].reduce((x,b)=>b.data>x?b.data:x,new Date(0))-g}),a=c.flatMap(n=>{const s=l[n],g=F[n]||"recent",B=[...s];switch(g){case"recent":B.sort((x,b)=>b.data-x.data);break;case"oldest":B.sort((x,b)=>x.data-b.data);break;case"joule-desc":B.sort((x,b)=>b.joule-b.joule);break;case"joule-asc":B.sort((x,b)=>x.joule-b.joule);break}return B}),m=(i?a.slice(0,E):a).reduce((n,s)=>{const g=s.pesoOriginale.toFixed(2);return n[g]||(n[g]=[]),n[g].push(s),n},{});if(c.forEach(n=>{if(!m[n])return;let s=m[n];const g=F[n]||"recent",x=l[n].reduce((f,h)=>f+h.joule,0)/l[n].length,b=l[n][0].unita.split(" ")[0],w=document.createElement("div");w.className="history-group bg-gray-100 dark:bg-gray-700 p-4 rounded-lg shadow-sm",w.dataset.groupPeso=n;const M=document.createElement("div");M.className="flex flex-col sm:flex-row justify-between items-center mb-2 cursor-pointer",M.addEventListener("click",f=>{if(f.target.closest("select, button"))return;const h=`list-${n}-${t.id}`,I=document.getElementById(h),j=M.querySelector(".collapse-icon");I&&(T[n]=!T[n],I.classList.toggle("collapsed",T[n]),j&&(j.style.transform=T[n]?"rotate(-90deg)":"rotate(0deg)"))});const z=document.createElement("span");z.className="collapse-icon text-blue-800 dark:text-blue-200 transition-transform duration-300",z.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>',z.style.transform=T[n]?"rotate(-90deg)":"rotate(0deg)";const R=document.createElement("div");R.className="flex items-center gap-2 bg-blue-200 text-blue-800 dark:bg-blue-900 dark:text-blue-200 text-sm font-bold p-2 rounded-md text-center mb-2 sm:mb-0 w-full sm:w-auto justify-between";const _=document.createElement("span");_.className="flex items-center gap-2",_.textContent=`Media Joule (${n} ${b}): ${x.toFixed(2)} J`,_.prepend(z),R.appendChild(_),M.appendChild(R);const ct=document.createElement("div");if(ct.className="flex items-center gap-2",l[n].length>1){const f=document.createElement("select");f.id=`sort-${n}`,f.setAttribute("data-peso",n),f.className="block pl-3 pr-8 py-1 text-xs border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 rounded-md",f.innerHTML=`
                <option value="recent" ${g==="recent"?"selected":""}>Più recente</option>
                <option value="oldest" ${g==="oldest"?"selected":""}>Meno recente</option>
                <option value="joule-desc" ${g==="joule-desc"?"selected":""}>Joule (Max)</option>
                <option value="joule-asc" ${g==="joule-asc"?"selected":""}>Joule (Min)</option>
            `,f.addEventListener("change",j=>{F[j.target.dataset.peso]=j.target.value,E=$,A(t,e,o,i)});const h=document.createElement("label");h.setAttribute("for",`sort-${n}`),h.className="text-sm text-gray-600 dark:text-gray-300",h.textContent="Ordina:";const I=document.createElement("div");I.className="flex items-center gap-2",I.appendChild(h),I.appendChild(f),ct.appendChild(I)}if(o){const f=document.createElement("div");f.className="flex items-center";const h=document.createElement("button");h.className="text-blue-500 hover:text-blue-700 p-1 rounded-full transition-colors duration-200",h.setAttribute("data-action","copy-group"),h.setAttribute("data-peso",n),h.setAttribute("aria-label",`Copia tutti i calcoli per il peso ${n}`),h.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>',f.appendChild(h);const I=document.createElement("button");I.className="text-red-500 hover:text-red-700 p-1 rounded-full transition-colors duration-200 ml-1",I.setAttribute("data-action","delete-group"),I.setAttribute("data-peso",n),I.setAttribute("aria-label",`Elimina tutti i calcoli per il peso ${n}`),I.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>',f.appendChild(I),R.appendChild(f)}M.appendChild(ct),w.appendChild(M);const H=document.createElement("div");H.id=`list-${n}-${t.id}`,H.className="history-list space-y-2 pt-2",T[n]&&H.classList.add("collapsed"),s.forEach(f=>{const h=document.createElement("div");h.className="history-item bg-gray-200 dark:bg-gray-600 p-3 rounded-md flex justify-between items-center",h.dataset.itemId=f.id,d.has(f.id)&&h.classList.add("history-item-animate");let I=o?`
                <button class="text-red-500 hover:text-red-700 p-1 rounded-full transition-colors duration-200" data-action="delete-single" data-id="${f.id}" aria-label="Elimina singolo calcolo">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>`:"";h.innerHTML=`
                <div>
                    <p class="text-sm font-medium dark:text-white">Joule: <span class="font-bold">${f.joule.toFixed(2)}</span></p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">${new Date(f.data).toLocaleString()}</p>
                </div>
                <div class="flex items-center gap-2">
                    <div class="text-right">
                        <p class="text-xs text-gray-700 dark:text-gray-300">Velocità: ${f.velocitaOriginale.toFixed(2)} ${f.unita.split(" ")[2]}</p>
                    </div>
                    ${I}
                </div>
            `,H.appendChild(h)}),w.appendChild(H),t.appendChild(w)}),i&&Se(t,a,o,i),t===S&&e.length>0){const n=Math.max(...e.map(g=>g.joule)),s=e.find(g=>g.joule===n);wt.classList.remove("hidden"),Wt.innerHTML=`
            <p>
                Il risultato più alto è di <span class="font-bold text-lg">${n.toFixed(2)} J</span>,
                ottenuto con un pallino da <span class="font-bold">${s.pesoOriginale.toFixed(2)} ${s.unita.split(" ")[0]}</span>
                e una velocità di <span class="font-bold">${s.velocitaOriginale.toFixed(2)} ${s.unita.split(" ")[2]}</span>.
            </p>
            <p class="text-xs text-gray-600 dark:text-gray-400 mt-2">Registrato il: ${new Date(s.data).toLocaleString()}</p>
        `}},k=(t,e)=>{t.addEventListener("keydown",o=>{o.key==="Enter"&&(o.preventDefault(),typeof e=="function"?(t.blur(),e()):e&&e.focus())})},$e=()=>{const t=Bt();if(t.length===0){y("Lo storico è vuoto. Nessun dato da esportare.",!1);return}const o=[["Data","Ora","Peso","Unita Peso","Velocita","Unita Velocita","Joule"].join(",")],i=[...t].sort((r,m)=>r.data-m.data);for(const r of i){const m=new Date(r.data),n=m.toLocaleDateString("it-IT"),s=m.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit",second:"2-digit"}),g=r.unita.split(" "),B=g[0],x=g[2],w=[n,s,r.pesoOriginale.toFixed(2),B,r.velocitaOriginale.toFixed(2),x,r.joule.toFixed(3)].map(M=>`"${String(M).replace(/"/g,'""')}"`);o.push(w.join(","))}const u=o.join(`
`),d=new Blob([u],{type:"text/csv;charset=utf-8;"}),l=URL.createObjectURL(d),c=document.createElement("a"),a=new Date().toISOString().slice(0,10).replace(/-/g,"");c.setAttribute("href",l),c.setAttribute("download",`storico_joule_${a}.csv`),c.style.visibility="hidden",document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(l),y("Esportazione CSV completata!")},et=()=>{const t=Bt();if(t.length===0)return"Nessun calcolo nello storico da condividere.";let e=`I miei risultati:

`;const o=t.reduce((d,l)=>{const c=l.pesoOriginale.toFixed(2);return d[c]||(d[c]={unita:l.unita,calcoli:[]}),d[c].calcoli.push(l),d},{});Object.keys(o).sort((d,l)=>{const c=Math.max(...o[d].calcoli.map(r=>r.data.getTime()));return Math.max(...o[l].calcoli.map(r=>r.data.getTime()))-c}).forEach(d=>{const l=o[d],c=l.unita.split(" ")[0],a=l.unita.split(" ")[2],r=l.calcoli.reduce((n,s)=>n+s.joule,0)/l.calcoli.length;e+=`--- Peso: ${d} ${c} (Media: ${r.toFixed(2)} J) ---
`,[...l.calcoli].sort((n,s)=>s.data-n.data).forEach(n=>{const s=new Date(n.data),g=s.toLocaleDateString("it-IT"),B=s.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"});e+=`- ${g} ${B} | ${n.joule.toFixed(2)} J (${n.velocitaOriginale.toFixed(2)} ${a})
`}),e+=`
`});const u=t.reduce((d,l)=>l.joule>d.joule?l:d,t[0]);return e+=`--- Risultato Massimo ---
`,e+=`Il valore più alto registrato è ${u.joule.toFixed(2)} J con un pallino da ${u.pesoOriginale.toFixed(2)} ${u.unita.split(" ")[0]} a ${u.velocitaOriginale.toFixed(2)} ${u.unita.split(" ")[2]}.
`,e},Jt=t=>{const o={title:"Storico Calcoli Joule",text:et()+`

---
Generato da Joule-Calc: https://joule-calc.web.app/`};navigator.share&&navigator.canShare&&navigator.canShare(o)?navigator.share(o).then(()=>y("Storico condiviso con successo!")).catch(i=>{i.name!=="AbortError"&&y("Condivisione annullata o fallita.",!1)}):y('La condivisione non è supportata su questo browser o dispositivo. Usa il tasto "Copia".',!1)},Te=()=>{if(Bt().length===0){y("Lo storico è vuoto. Nessun dato da stampare.",!1);return}const e=et().replace(/---/g,'<hr style="margin: 20px 0; border: 1px solid #ccc;">').replace(/\n/g,"<br>"),o=window.open("","_blank");o.document.write(`
        <html>
        <head>
            <title>Stampa Storico - Joule-Calc</title>
            <style>
                body { 
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
                    line-height: 1.6; 
                    color: #333;
                }
                h1 { 
                    text-align: center; 
                    border-bottom: 2px solid #eee; 
                    padding-bottom: 10px; 
                    margin-bottom: 20px;
                }
                hr {
                    border: 0;
                    border-top: 1px solid #ddd;
                    margin: 20px 0;
                }
                p { margin: 0; }
                .footer { 
                    margin-top: 30px; 
                    text-align: center; 
                    font-size: 0.8em; 
                    color: #777;
                }
            </style>
        </head>
        <body>
            <h1>Storico Calcoli Joule-Calc</h1>
            <p>${e}</p>
            <div class="footer">
                Generato da Joule-Calc: https://joule-calc.web.app/
            </div>
        </body>
        </html>
    `),o.document.close(),o.focus(),o.print()};function Oe(t,e,o){if(isNaN(t)||isNaN(e)||t<=0||e<=0)throw new Error("Valori di input non validi.");return o&&(t=t*_t,e=e*Ut),.5*(t/1e3)*(e*e)}function De(t,e,o){if(isNaN(t)||isNaN(e)||t<=0||e<=0)throw new Error("Valori di input non validi.");let i;o?i=e*_t/1e3:i=e/1e3;const u=Math.sqrt(2*t/i),d=u/Ut;return{mps:u,fps:d}}function Ae(t){const{isMrad:e,distance:o,drop:i,drift:u,clickValue:d}=t;if(isNaN(o)||o<=0||i<=0&&u<=0)throw new Error("Distanza o deviazione non valide.");const l=c=>{if(c<=0)return{value:0,clicks:0};let a;e?a=c/(o/10):a=c/o*100/2.9089;const r=a/d;return{value:a,clicks:r}};return{elevation:l(i),windage:l(u)}}let P=null;function He(t,e,o){const i=o.isMrad?"MRAD":"MOA",u=o.dropDirection==="Down"?"l'alto":"il basso",d=o.driftDirection==="Right"?"sinistra":"destra";let l='<p class="font-semibold mb-1">Verticale</p>';t.clicks>0?l+=`<div><span class="font-bold text-xl">${t.clicks.toFixed(1)} clicks</span></div><div class="text-xs">(${t.value.toFixed(2)} ${i}) verso ${u}</div>`:l+='<p class="text-sm text-gray-600 dark:text-gray-400">Nessuna correzione</p>',Pt.innerHTML=l;let c='<p class="font-semibold mb-1">Orizzontale</p>';e.clicks>0?c+=`<div><span class="font-bold text-xl">${e.clicks.toFixed(1)} clicks</span></div><div class="text-xs">(${e.value.toFixed(2)} ${i}) verso ${d}</div>`:c+='<p class="text-sm text-gray-600 dark:text-gray-400">Nessuna correzione</p>',zt.innerHTML=c}const Q=(t,e)=>{!t||P||(e&&e(),xt(t),P=t,history.pushState({modalOpen:!0,modalId:t.id},"",`#${t.id}`))},O=(t,e=!1)=>{!t||t.style.display==="none"||(ht(t),P=null,!e&&history.state&&history.state.modalOpen&&history.go(-1))},tt="jouleCalcUnitSystem",Nt=t=>{fe(t),localStorage.setItem(tt,t),document.querySelectorAll("[data-unit-selector]").forEach(o=>{const i=o.querySelector('[data-unit-button="metrico"]'),u=o.querySelector('[data-unit-button="imperiale"]');i&&i.classList.toggle("active-unit",t==="metrico"),u&&u.classList.toggle("active-unit",t==="imperiale")})},vt=new Audio(Kt);vt.preload="auto";const ut=()=>{vt.currentTime=0,vt.play().catch(t=>console.warn("La riproduzione del suono non è riuscita:",t))},p=(t=10)=>{navigator&&"vibrate"in navigator&&navigator.vibrate(t)};document.addEventListener("DOMContentLoaded",()=>{document.getElementById("appContainer")&&je(),window.addEventListener("popstate",t=>{if(!Rt.classList.contains("translate-x-full"))V(!1,!0);else if(P)O(P,!0);else if(t.state&&t.state.modalId){const e=document.getElementById(t.state.modalId);e&&O(e,!0)}else t.state&&t.state.menuOpen&&V(!1,!0)})});function je(){Yt(qt()),Ne(),document.body.addEventListener("click",a=>{const m=a.target.closest("button");if(!m)return;const n=m.dataset.helpTopic;n&&(p(),Q(pt,()=>ve(n)));const s=m.id;if(s==="infoBtn"){p(),Q(Ct);return}if(s==="closeInfoModalBtn"){O(Ct);return}if(s==="confirmYesBtn"){p(20),ht(mt);const g=ge();g&&g(),Ht();return}if(s==="confirmNoBtn"){p(),ht(mt),Ht();return}if(s==="closeSectionHelpModalBtn"){p(),O(pt);return}if(s==="menu-btn"){p(),V(!0);return}if(s==="close-menu-btn"){p(),V(!1);return}if(s==="calcolaBtn"){o();return}if(s==="calcolaVelocitaBtn"){i();return}if(s==="calcolaMoaBtn"){u();return}if(s==="clearHistoryBtn"||s==="clearAllHistoryBtn"){p(20),Le();return}if(s==="copyHistoryBtn"||s==="copyAllHistoryBtn"||s==="exportTxtBtnModal"){p(),yt(et(),"Storico copiato negli appunti!");return}if(s==="shareHistoryBtn"||s==="shareBtnModal"){p(),Jt();return}if(s==="exportBtn"){p(),Q(kt);return}if(s==="openHistoryModalBtn"){p(),Q(dt);return}}),ft&&ft.addEventListener("click",()=>{p(),V(!1)}),Me();const t=()=>{const a=window.innerHeight*.01;document.documentElement.style.setProperty("--vh",`${a}px`)};window.addEventListener("resize",t),t(),Ot&&Tt&&Ot.addEventListener("click",()=>{p(),Tt.scrollIntoView({behavior:"smooth"})}),Dt&&$t&&Dt.addEventListener("click",()=>{p(),$t.scrollIntoView({behavior:"smooth"})}),K&&Y&&(K.addEventListener("click",a=>{a.preventDefault(),p(),Y.scrollTo({top:0,behavior:"smooth"})}),Y.addEventListener("scroll",()=>{const a=Y.scrollTop>50;K.classList.toggle("opacity-100",a),K.classList.toggle("pointer-events-auto",a)}));let e;if(C&&q){window.addEventListener("beforeinstallprompt",r=>{r.preventDefault(),e=r;const m=localStorage.getItem("joule-calc-install-banner-dismissed-timestamp");!m||Date.now()-parseInt(m,10)>7*24*60*60*1e3?q.classList.remove("hidden"):C.classList.remove("hidden","opacity-0")});const a=()=>{e&&(p(),e.prompt(),C.classList.add("hidden"),q.classList.add("hidden"))};C.addEventListener("click",a),re.addEventListener("click",a),ce.addEventListener("click",()=>{p(),q.classList.add("hidden"),localStorage.setItem("joule-calc-install-banner-dismissed-timestamp",Date.now().toString()),C.classList.contains("hidden")&&(C.classList.remove("hidden"),setTimeout(()=>C.classList.remove("opacity-0"),10))}),window.addEventListener("appinstalled",()=>{e=null,y("App installata con successo!",!0)})}const o=()=>{p();try{const a=parseFloat(D.value),r=parseFloat(L.value),m=(localStorage.getItem(tt)||"metrico")==="imperiale",n=Oe(a,r,m);ut(),Xt.innerHTML=`<span class="font-semibold">Energia in Joule:</span> <span id="joule-value" class="font-bold text-xl">${n.toFixed(2)}</span>`,Be()?y("Storico pieno! Calcolo non salvato.",!1):(Ie({id:Date.now(),pesoOriginale:a,velocitaOriginale:r,unita:m?"gr e fps":"g e m/s",joule:n,data:new Date}),y("Calcolo salvato nello storico!")),L.value=""}catch{y("Dati non validi!",!1)}},i=()=>{p();try{const a=parseFloat(X.value),r=parseFloat(J.value),m=(localStorage.getItem(tt)||"metrico")==="imperiale",{mps:n,fps:s}=De(a,r,m);ut(),ae.innerHTML=`<p class="font-semibold">Velocità necessaria:</p><p><span class="font-bold text-xl">${n.toFixed(2)}</span> m/s</p><p><span class="font-bold text-xl">${s.toFixed(2)}</span> fps</p>`}catch{y("Dati non validi!",!1)}},u=()=>{p();try{const a={isMrad:W.checked,distance:parseFloat(Z.value),drop:parseFloat(N.value)||0,drift:parseFloat(G.value)||0,dropDirection:document.getElementById("dropDirection").value,driftDirection:se.value,clickValue:parseFloat(gt.value)},{elevation:r,windage:m}=Ae(a);ut(),He(r,m,a)}catch{Pt.innerHTML='<p class="font-semibold mb-1">Verticale</p><p class="text-sm text-gray-600 dark:text-gray-400">Nessuna correzione</p>',zt.innerHTML='<p class="font-semibold mb-1">Orizzontale</p><p class="text-sm text-gray-600 dark:text-gray-400">Nessuna correzione</p>',y("Dati non validi!",!1)}};D&&L&&Qt&&(k(D,L),k(L,o)),X&&J&&ne&&(k(X,J),k(J,i)),Z&&N&&G&&le&&(k(Z,N),k(N,G),k(G,u)),document.body.addEventListener("click",a=>{const r=a.target.closest("[data-unit-button]");r&&(p(),Nt(r.dataset.unitButton))});const d=[ot,nt,st],l=[at,it,lt];if(ie&&d.forEach((a,r)=>{a&&a.addEventListener("click",()=>{p(),Et(d[r],l[r])})}),S&&S.addEventListener("click",a=>{const r=a.target.closest("button[data-action]");if(!r)return;const m=r.dataset.action,n=r.dataset.id,s=r.dataset.peso;m==="delete-single"&&n?we(n):m==="delete-group"&&s?Ce(s):m==="copy-group"&&s&&ke(s)}),kt){const a=document.getElementById("exportModal");a&&a.addEventListener("click",r=>{const m=r.target;(m.id==="closeExportModalBtn"||m.closest("#closeExportModalBtn"))&&(p(),O(a)),(r.target.id==="exportCsvBtnModal"||r.target.closest("#exportCsvBtnModal"))&&(p(),$e()),(r.target.id==="exportTxtBtnModal"||r.target.closest("#exportTxtBtnModal"))&&(p(),yt(et(),"Storico copiato negli appunti!")),(r.target.id==="printBtnModal"||r.target.closest("#printBtnModal"))&&(p(),Te()),(r.target.id==="shareBtnModal"||r.target.closest("#shareBtnModal"))&&(p(),Jt())})}if(dt){const a=document.getElementById("closeHistoryModalXBtn");a&&a.addEventListener("click",()=>{p(),O(dt)})}const c=localStorage.getItem(tt)||"metrico";Nt(c),W&&(jt(),W.addEventListener("change",()=>{p(),jt()})),Ft(),window.addEventListener("hashchange",Ft),Je()}function V(t,e=!1){const o=Rt,i=ft;!o||!i||(t?(e||history.pushState({menuOpen:!0},""),i.classList.remove("hidden"),o.classList.remove("translate-x-full")):(!e&&history.state&&history.state.menuOpen&&history.back(),i.classList.add("hidden"),o.classList.add("translate-x-full")))}const Yt=t=>{he(t);const e=t==="dark"?"#1f2937":"#ffffff",o=document.querySelector('meta[name="theme-color"]');o&&o.setAttribute("content",e)};function Et(t,e){[at,it,lt].forEach(i=>i.classList.add("hidden")),e.classList.remove("hidden"),be(t)}function Ft(){const t=window.location.hash.substring(1),e={joule:{tab:ot,panel:at},velocity:{tab:nt,panel:it},compensation:{tab:st,panel:lt}};t&&e[t]&&Et(e[t].tab,e[t].panel)}function Je(){"launchQueue"in window&&launchQueue.setConsumer(t=>{if(!t.targetURL)return;const e=new URL(t.targetURL),o=new URLSearchParams(e.search),i=o.get("tab"),u={joule:{tab:ot,panel:at},velocity:{tab:nt,panel:it},compensation:{tab:st,panel:lt}};if(i&&u[i]&&Et(u[i].tab,u[i].panel),i==="joule"){const d=o.get("peso"),l=o.get("velocita");d&&(D.value=d),l&&(L.value=l)}if(i==="velocity"){const d=o.get("joule"),l=o.get("peso");d&&(X.value=d),l&&(J.value=l)}if(i==="compensation"){const d=o.get("distanza"),l=o.get("spostamento");d&&(Z.value=d),l&&(N.value=l)}})}function Ne(){document.querySelectorAll("#theme-switcher").forEach(t=>{t.addEventListener("click",()=>{const e=qt()==="dark"?"light":"dark";localStorage.setItem("theme",e),Yt(e)})})}
